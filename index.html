<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>CFM Utility Locate Tracker</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Space+Grotesk:wght@500;600&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        color-scheme: light;
        --bg: #f3f4f8;
        --surface: #ffffff;
        --surface-subtle: rgba(255, 255, 255, 0.65);
        --primary: #1363df;
        --primary-dark: #0f4cc3;
        --accent: #52d6b2;
        --text: #121625;
        --muted: #5e6478;
        --border: rgba(19, 99, 223, 0.12);
        --radius-lg: 24px;
        --radius: 16px;
        --shadow: 0 24px 48px rgba(14, 38, 74, 0.12);
      }

      *,
      *::before,
      *::after {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: radial-gradient(circle at top, rgba(19, 99, 223, 0.18), transparent 60%), var(--bg);
        color: var(--text);
        min-height: 100vh;
      }

      .hidden {
        display: none !important;
      }

      .auth-screen {
        min-height: 100vh;
        display: grid;
        place-items: center;
        padding: clamp(2rem, 6vw, 4rem);
      }

      .auth-card {
        width: min(100%, 460px);
        background: var(--surface);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow);
        padding: clamp(2.2rem, 6vw, 3.2rem);
        display: grid;
        gap: 1.5rem;
        text-align: center;
      }

      .auth-brand {
        display: grid;
        gap: 0.9rem;
        justify-items: center;
      }

      .auth-brand span {
        width: 56px;
        height: 56px;
        border-radius: 18px;
        display: grid;
        place-items: center;
        font-family: "Space Grotesk", sans-serif;
        font-size: 1.35rem;
        color: #fff;
        background: linear-gradient(135deg, var(--primary), #48a9f8);
        box-shadow: 0 18px 36px rgba(19, 99, 223, 0.28);
      }

      .auth-subtitle {
        font-size: 0.98rem;
        color: var(--muted);
      }

      .auth-form {
        display: grid;
        gap: 1rem;
        text-align: left;
      }

      .auth-form button {
        justify-content: center;
        width: 100%;
      }

      .auth-message {
        padding: 0.85rem 1rem;
        border-radius: 12px;
        font-size: 0.92rem;
        text-align: left;
      }

      .auth-message.info {
        background: rgba(19, 99, 223, 0.08);
        color: var(--primary-dark);
      }

      .auth-message.success {
        background: rgba(82, 214, 178, 0.18);
        color: #106e52;
      }

      .auth-message.error {
        background: rgba(232, 94, 94, 0.15);
        color: #9c1d1d;
      }

      .auth-switch {
        font-size: 0.9rem;
        color: var(--muted);
      }

      .auth-link {
        background: none !important;
        border: none !important;
        color: var(--primary-dark);
        font-weight: 600;
        cursor: pointer;
        padding: 0 !important;
        text-decoration: underline;
        display: inline !important;
        box-shadow: none !important;
      }

      .auth-link:hover,
      .auth-link:focus {
        color: var(--primary);
        outline: none;
      }

      h1,
      h2,
      h3 {
        font-family: "Space Grotesk", "Inter", sans-serif;
        font-weight: 600;
        margin: 0;
        color: var(--text);
      }

      p {
        margin: 0;
        color: var(--muted);
      }

      header {
        position: sticky;
        top: 0;
        z-index: 20;
        backdrop-filter: blur(16px);
        background: rgba(243, 244, 248, 0.88);
        border-bottom: 1px solid var(--border);
      }

      .nav-container {
        max-width: 1120px;
        margin: 0 auto;
        padding: 1.1rem clamp(1rem, 4vw, 2.5rem);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 1.25rem;
        flex-wrap: wrap;
        text-align: center;
        position: relative;
      }

      .nav-left {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 1.35rem;
        flex-wrap: wrap;
      }

      .brand {
        display: inline-flex;
        align-items: center;
        gap: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--primary-dark);
        font-weight: 600;
        font-size: 0.95rem;
      }

      .nav-right {
        position: absolute;
        right: clamp(1rem, 4vw, 2.5rem);
        display: inline-flex;
        align-items: center;
        gap: 0.75rem;
      }

      .user-tag {
        background: rgba(18, 22, 37, 0.08);
        color: var(--text);
        border-radius: 999px;
        padding: 0.45rem 0.9rem;
        font-size: 0.85rem;
        font-weight: 600;
      }

      .logout-btn {
        padding: 0.55rem 1.15rem;
      }

      .brand span {
        width: 44px;
        height: 44px;
        border-radius: 14px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-family: "Space Grotesk", sans-serif;
        font-size: 1.25rem;
        color: #fff;
        background: linear-gradient(135deg, var(--primary), #48a9f8);
        box-shadow: 0 14px 28px rgba(19, 99, 223, 0.32);
      }

      main {
        max-width: 1120px;
        margin: 0 auto;
        padding: clamp(2.5rem, 6vw, 4.5rem) clamp(1.25rem, 5vw, 2.75rem) 4rem;
        display: grid;
        gap: clamp(2rem, 5vw, 3.5rem);
      }

      .hero {
        background: var(--surface);
        box-shadow: var(--shadow);
        border-radius: var(--radius-lg);
        padding: clamp(2rem, 5vw, 3rem);
        position: relative;
        overflow: hidden;
      }

      .hero::after {
        content: "";
        position: absolute;
        inset: 0;
        background: radial-gradient(circle at top right, rgba(19, 99, 223, 0.16), transparent 55%);
        pointer-events: none;
      }

      .hero-content {
        display: grid;
        gap: clamp(1rem, 3vw, 1.5rem);
        max-width: 640px;
        position: relative;
        z-index: 1;
      }

      .hero h1 {
        font-size: clamp(2rem, 4vw, 3rem);
        line-height: 1.12;
      }

      .hero p {
        font-size: 1.02rem;
        line-height: 1.6;
      }

      .stats {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        margin-top: 1.5rem;
      }

      .stat-card {
        padding: 1.15rem 1.4rem;
        border-radius: 18px;
        background: rgba(19, 99, 223, 0.08);
        color: var(--primary-dark);
        min-width: 160px;
      }

      .stat-card strong {
        display: block;
        font-size: 1.5rem;
        margin-bottom: 0.35rem;
      }

      section {
        background: var(--surface);
        border-radius: var(--radius-lg);
        padding: clamp(1.75rem, 5vw, 2.75rem);
        box-shadow: var(--shadow);
      }

      .section-heading {
        display: flex;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 1rem;
        align-items: center;
        margin-bottom: clamp(1.5rem, 4vw, 2rem);
      }

      .section-heading p {
        max-width: 520px;
      }

      .ticket-form {
        display: grid;
        gap: 1rem;
      }

      .form-grid {
        display: grid;
        gap: 1rem;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      }

      label {
        display: grid;
        gap: 0.45rem;
        font-weight: 600;
        color: var(--text);
        font-size: 0.95rem;
      }

      input,
      textarea,
      select {
        font: inherit;
        padding: 0.75rem 0.85rem;
        border-radius: 12px;
        border: 1px solid rgba(18, 22, 37, 0.12);
        background: rgba(255, 255, 255, 0.96);
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
      }

      input:focus,
      textarea:focus,
      select:focus {
        outline: none;
        border-color: rgba(19, 99, 223, 0.5);
        box-shadow: 0 0 0 3px rgba(19, 99, 223, 0.12);
      }

      textarea {
        resize: vertical;
        min-height: 120px;
      }

      .file-input {
        border: 1px dashed rgba(19, 99, 223, 0.45);
        background: rgba(19, 99, 223, 0.06);
        border-radius: 16px;
        padding: 1.5rem;
        text-align: center;
        color: var(--muted);
        cursor: pointer;
        transition: background 0.2s ease, border 0.2s ease;
      }

      .file-input:hover,
      .file-input:focus-within {
        background: rgba(19, 99, 223, 0.1);
        border-color: rgba(19, 99, 223, 0.9);
      }

      .file-input input[type="file"] {
        border: 0;
        padding: 0.25rem;
        border-radius: 8px;
        background: transparent;
        margin: 0 auto;
      }

      .form-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
        justify-content: flex-end;
      }

      button {
        font: inherit;
        border-radius: 12px;
        border: none;
        padding: 0.75rem 1.4rem;
        font-weight: 600;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
      }

      .btn-primary {
        background: linear-gradient(135deg, var(--primary), var(--primary-dark));
        color: #fff;
        box-shadow: 0 16px 32px rgba(19, 99, 223, 0.28);
      }

      .btn-primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 18px 36px rgba(19, 99, 223, 0.35);
      }

      .btn-secondary {
        background: rgba(18, 22, 37, 0.08);
        color: var(--text);
      }

      .btn-secondary:hover {
        background: rgba(18, 22, 37, 0.12);
      }

      .photo-preview {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 0.8rem;
      }

      .photo-card {
        border-radius: 14px;
        overflow: hidden;
        background: rgba(19, 99, 223, 0.08);
        border: 1px solid rgba(19, 99, 223, 0.18);
        display: grid;
        gap: 0.4rem;
      }

      .photo-card img {
        width: 100%;
        height: 120px;
        object-fit: cover;
      }

      .photo-card span {
        display: block;
        padding: 0.55rem 0.75rem 0.7rem;
        font-size: 0.85rem;
        color: var(--muted);
        background: rgba(255, 255, 255, 0.85);
      }

      .tickets-toolbar {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 1.5rem;
      }

      .tickets-toolbar input {
        width: min(320px, 100%);
      }

      .tickets-empty {
        text-align: center;
        padding: 3rem 1rem;
        color: var(--muted);
      }

      .ticket-grid {
        display: grid;
        gap: 1.25rem;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      }

      .ticket-card {
        background: rgba(255, 255, 255, 0.92);
        border-radius: 18px;
        padding: 1.4rem;
        border: 1px solid rgba(18, 22, 37, 0.06);
        display: grid;
        gap: 1.1rem;
        position: relative;
      }

      .ticket-card header {
        background: none;
        border: 0;
        position: static;
        padding: 0;
      }

      .ticket-card h3 {
        font-size: 1.25rem;
      }

      .ticket-meta {
        display: grid;
        gap: 0.55rem;
        font-size: 0.92rem;
      }

      .ticket-meta span {
        color: var(--muted);
      }

      .attachment-thumbs {
        display: flex;
        gap: 0.5rem;
      }

      .attachment-thumbs img {
        width: 52px;
        height: 52px;
        border-radius: 12px;
        object-fit: cover;
        border: 1px solid rgba(19, 99, 223, 0.25);
      }

      .badge {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        background: rgba(19, 99, 223, 0.1);
        color: var(--primary-dark);
        border-radius: 999px;
        padding: 0.35rem 0.75rem;
        font-size: 0.8rem;
        font-weight: 600;
      }

      .ticket-actions {
        display: flex;
        align-items: center;
        justify-content: flex-start;
      }

      details {
        background: rgba(19, 99, 223, 0.05);
        border-radius: 14px;
        padding: 0.9rem 1rem;
      }

      details summary {
        cursor: pointer;
        font-weight: 600;
        color: var(--primary-dark);
        list-style: none;
      }

      details[open] summary::after {
        content: "";
      }

      summary::-webkit-details-marker {
        display: none;
      }

      .details-body {
        margin-top: 0.85rem;
        display: grid;
        gap: 0.75rem;
      }

      dialog {
        border: none;
        border-radius: 18px;
        padding: 0;
        box-shadow: 0 20px 50px rgba(12, 27, 51, 0.45);
        background: rgba(10, 15, 28, 0.85);
      }

      dialog::backdrop {
        background: rgba(5, 8, 15, 0.55);
      }

      @media (max-width: 720px) {
        header {
          position: static;
        }

        .nav-container {
          justify-content: center;
          gap: 0.9rem;
        }

        .nav-left {
          width: 100%;
          justify-content: center;
          gap: 0.9rem;
        }

        .brand {
          justify-content: center;
        }

        .nav-right {
          position: static;
          width: 100%;
          justify-content: center;
        }

        .badge {
          width: 100%;
          justify-content: center;
        }

        .hero {
          padding: 1.75rem;
        }

        .ticket-actions {
          align-items: flex-start;
        }
      }
    </style>
  </head>
  <body>
    <div class="auth-screen" id="authScreen">
      <div class="auth-card" role="region" aria-labelledby="authTitle">
        <div class="auth-brand">
          <span>CF</span>
          <h1 id="authTitle">CFM Utility Locate Tracker</h1>
        </div>
        <p class="auth-subtitle">
          Log in to manage locate tickets, attachments, and onsite documentation in one streamlined workspace.
        </p>
        <div id="authMessage" class="auth-message hidden" role="status" aria-live="polite"></div>
        <form class="auth-form" id="loginForm" autocomplete="on">
          <label>
            Email address
            <input type="email" id="loginEmail" name="loginEmail" autocomplete="email" required />
          </label>
          <label>
            Access password
            <input
              type="password"
              id="loginPassword"
              name="loginPassword"
              autocomplete="current-password"
              required
            />
          </label>
          <button type="submit" class="btn-primary">Sign in</button>
        </form>

        <form class="auth-form hidden" id="registerForm" autocomplete="off">
          <label>
            Full name
            <input type="text" id="registerName" name="registerName" autocomplete="name" required />
          </label>
          <label>
            Email address
            <input type="email" id="registerEmail" name="registerEmail" autocomplete="email" required />
          </label>
          <label>
            Create password
            <input
              type="password"
              id="registerPassword"
              name="registerPassword"
              autocomplete="new-password"
              minlength="6"
              required
            />
          </label>
          <label>
            Confirm password
            <input
              type="password"
              id="registerConfirm"
              name="registerConfirm"
              autocomplete="new-password"
              minlength="6"
              required
            />
          </label>
          <button type="submit" class="btn-primary">Create account</button>
        </form>

        <p class="auth-switch" id="toRegister">
          Need to set up access?
          <button type="button" class="auth-link" id="showRegister">Create team account</button>
        </p>
        <p class="auth-switch hidden" id="toLogin">
          Already have access?
          <button type="button" class="auth-link" id="showLogin">Back to sign in</button>
        </p>
      </div>
    </div>

    <div id="appShell" class="hidden">
      <header>
        <div class="nav-container">
          <div class="nav-left">
            <a class="brand" href="#top"><span>CF</span>CFM Utility Locate Tracker</a>
            <div class="badge" aria-live="polite" id="ticketCount">0 active tickets</div>
          </div>
          <div class="nav-right">
            <div class="user-tag hidden" id="userGreeting"></div>
            <button type="button" class="btn-secondary logout-btn hidden" id="logoutBtn">Log out</button>
          </div>
        </div>
      </header>

      <main>
      <section class="hero" id="top">
        <div class="hero-content">
          <h1>Centralize your locate tickets and documentation</h1>
          <p>
            Use this lightweight utility locate database to log ticket numbers, capture site details, and attach
            photos from the field. Everything stays organized, searchable, and exportable so your crews can confirm
            coverage before they dig.
          </p>
          <div class="stats" role="list">
            <div class="stat-card" role="listitem">
              <strong id="statTickets">0</strong>
              Tickets logged
            </div>
            <div class="stat-card" role="listitem">
              <strong id="statAttachments">0</strong>
              Photos archived
            </div>
            <div class="stat-card" role="listitem">
              <strong id="statOpen">0</strong>
              Open locates
            </div>
          </div>
        </div>
      </section>

      <section aria-labelledby="formHeading">
        <div class="section-heading">
          <div>
            <h2 id="formHeading">Create a locate ticket</h2>
            <p>
              Enter the ticket details, upload field photos, and keep everything accessible for inspectors and crews.
              All data is stored locally in your browser and can be exported as JSON if you need to back it up.
            </p>
          </div>
        </div>

        <form class="ticket-form" id="ticketForm">
          <div class="form-grid">
            <label>
              Ticket number
              <input type="text" name="ticketNumber" id="ticketNumber" required placeholder="e.g. 23-584217" />
            </label>
            <label>
              Job site / address
              <input type="text" name="location" id="location" placeholder="123 Main St, Springfield" />
            </label>
            <label>
              Locator
              <select name="utilityType" id="utilityType">
                <option value="">Select locator</option>
                <option>T. Benza</option>
                <option>L. Schrimer</option>
                <option>J. Juhasz</option>
                <option>S. Lee</option>
                <option>M. Lam</option>
                <option>S. McDonald</option>
              </select>
            </label>
            <label>
              Date located
              <input type="date" name="dueDate" id="dueDate" />
            </label>
          </div>

          <label>
            Notes
            <textarea name="notes" id="notes" placeholder="Flags, obstacles, access notes, and contacts..."></textarea>
          </label>

          <label class="file-input">
            <strong>Attach field photos</strong>
            <span>Upload multiple images to document marks, utilities, and site conditions.</span>
            <input type="file" id="photos" name="photos" accept="image/*" multiple />
          </label>

          <div class="photo-preview" id="photoPreview" aria-live="polite"></div>

          <div class="form-actions">
            <button type="reset" class="btn-secondary" id="resetForm">Clear form</button>
            <button type="submit" class="btn-primary">Save ticket</button>
          </div>
        </form>
      </section>

      <section aria-labelledby="ticketsHeading">
        <div class="section-heading">
          <div>
            <h2 id="ticketsHeading">Ticket archive</h2>
            <p>Search by ticket number, filter by status, and review attachments for each locate request.</p>
          </div>
          <button class="btn-secondary" type="button" id="exportBtn">Export data</button>
        </div>

        <div class="tickets-toolbar">
          <input type="search" id="searchTickets" placeholder="Search ticket number..." />
          <select id="statusFilter">
            <option value="all">All tickets</option>
            <option value="open">Open</option>
            <option value="completed">Completed</option>
          </select>
        </div>

        <div id="ticketsContainer"></div>
      </section>
      </main>

      <template id="ticketTemplate">
        <article class="ticket-card">
          <header>
            <h3 data-ticket-number></h3>
            <div class="ticket-meta">
              <span data-location></span>
              <span data-utility></span>
              <span data-due></span>
            </div>
          </header>
          <div class="ticket-actions">
            <span class="badge" data-status-badge></span>
          </div>
          <details>
            <summary>Notes & photos</summary>
            <div class="details-body">
              <p data-notes></p>
              <div class="attachment-thumbs" data-attachments></div>
            </div>
          </details>
        </article>
      </template>

      <dialog id="imageDialog">
        <img src="" alt="Ticket attachment" id="dialogImage" style="max-width: 90vw; max-height: 80vh" />
      </dialog>
    </div>

    <script>
      const STORAGE_KEY = "utilityLocateTickets_v1";
      const USERS_KEY = "cfmLocateUsers_v1";
      const SESSION_KEY = "cfmLocateSession_v1";

      const appShell = document.getElementById("appShell");
      const authScreen = document.getElementById("authScreen");
      const authMessage = document.getElementById("authMessage");
      const authLoginForm = document.getElementById("loginForm");
      const authRegisterForm = document.getElementById("registerForm");
      const showRegisterBtn = document.getElementById("showRegister");
      const showLoginBtn = document.getElementById("showLogin");
      const toRegister = document.getElementById("toRegister");
      const toLogin = document.getElementById("toLogin");
      const loginEmailInput = document.getElementById("loginEmail");
      const loginPasswordInput = document.getElementById("loginPassword");
      const registerNameInput = document.getElementById("registerName");
      const registerEmailInput = document.getElementById("registerEmail");
      const registerPasswordInput = document.getElementById("registerPassword");
      const registerConfirmInput = document.getElementById("registerConfirm");
      const userGreeting = document.getElementById("userGreeting");
      const logoutBtn = document.getElementById("logoutBtn");

      const ticketForm = document.getElementById("ticketForm");
      const photoInput = document.getElementById("photos");
      const photoPreview = document.getElementById("photoPreview");
      const ticketsContainer = document.getElementById("ticketsContainer");
      const ticketTemplate = document.getElementById("ticketTemplate");
      const searchTickets = document.getElementById("searchTickets");
      const statusFilter = document.getElementById("statusFilter");
      const ticketCount = document.getElementById("ticketCount");
      const statTickets = document.getElementById("statTickets");
      const statAttachments = document.getElementById("statAttachments");
      const statOpen = document.getElementById("statOpen");
      const exportBtn = document.getElementById("exportBtn");
      const resetFormBtn = document.getElementById("resetForm");
      const imageDialog = document.getElementById("imageDialog");
      const dialogImage = document.getElementById("dialogImage");

      let users = loadUsers();
      let tickets = loadTickets();

      initializeAuth();
      renderTickets();

      authLoginForm?.addEventListener("submit", (event) => {
        event.preventDefault();
        const email = normalizeEmail(loginEmailInput?.value || "");
        const password = loginPasswordInput?.value || "";
        if (!email || !password) {
          showAuthMessage("Both email and password are required.", "error");
          return;
        }

        const user = findUser(email);
        if (!user || user.password !== encodePassword(password)) {
          showAuthMessage("We couldn't match those credentials. Try again.", "error");
          return;
        }

        startSession(user);
        authLoginForm.reset();
        clearAuthMessage();
        showApp(user);
      });

      authRegisterForm?.addEventListener("submit", (event) => {
        event.preventDefault();
        const name = (registerNameInput?.value || "").trim();
        const email = normalizeEmail(registerEmailInput?.value || "");
        const password = registerPasswordInput?.value || "";
        const confirm = registerConfirmInput?.value || "";

        if (!name || !email || !password || !confirm) {
          showAuthMessage("All fields are required to create an account.", "error");
          return;
        }

        if (password.length < 6) {
          showAuthMessage("Passwords must be at least 6 characters long.", "error");
          return;
        }

        if (password !== confirm) {
          showAuthMessage("Passwords do not match. Please re-enter them.", "error");
          return;
        }

        if (findUser(email)) {
          showAuthMessage("That email already has access. Sign in instead.", "error");
          setAuthMode("login");
          if (loginEmailInput) {
            loginEmailInput.value = email;
          }
          loginPasswordInput?.focus();
          return;
        }

        const newUser = { name, email, password: encodePassword(password) };
        users.push(newUser);
        saveUsers();
        startSession(newUser);
        authRegisterForm.reset();
        clearAuthMessage();
        showApp(newUser);
      });

      showRegisterBtn?.addEventListener("click", () => {
        clearAuthMessage();
        setAuthMode("register");
      });

      showLoginBtn?.addEventListener("click", () => {
        if (!users.length) return;
        clearAuthMessage();
        setAuthMode("login");
      });

      logoutBtn?.addEventListener("click", () => {
        clearSession();
        authLoginForm?.reset();
        authRegisterForm?.reset();
        showAuth("login", { clearMessage: false });
        showAuthMessage("You have been signed out.", "info");
      });

      function initializeAuth() {
        const sessionEmail = sessionStorage.getItem(SESSION_KEY);
        if (sessionEmail) {
          const existingUser = findUser(sessionEmail);
          if (existingUser) {
            showApp(existingUser);
            return;
          }
          clearSession();
        }
        showAuth(users.length ? "login" : "register");
      }

      function showApp(user) {
        updateUserUI(user);
        authScreen?.classList.add("hidden");
        appShell?.classList.remove("hidden");
      }

      function showAuth(mode = users.length ? "login" : "register", { clearMessage = true } = {}) {
        if (clearMessage) {
          clearAuthMessage();
        }
        updateUserUI();
        appShell?.classList.add("hidden");
        authScreen?.classList.remove("hidden");
        setAuthMode(mode);
      }

      function setAuthMode(mode) {
        const isLogin = mode === "login";
        authLoginForm?.classList.toggle("hidden", !isLogin);
        authRegisterForm?.classList.toggle("hidden", isLogin);
        toRegister?.classList.toggle("hidden", !isLogin);
        toLogin?.classList.toggle("hidden", isLogin || users.length === 0);
        window.requestAnimationFrame(() => {
          if (isLogin) {
            loginEmailInput?.focus();
          } else {
            registerNameInput?.focus();
          }
        });
      }

      function updateUserUI(user = null) {
        if (!userGreeting || !logoutBtn) return;
        if (user) {
          userGreeting.textContent = user.name
            ? `Signed in as ${user.name}`
            : `Signed in as ${user.email}`;
          userGreeting.classList.remove("hidden");
          logoutBtn.classList.remove("hidden");
        } else {
          userGreeting.textContent = "";
          userGreeting.classList.add("hidden");
          logoutBtn.classList.add("hidden");
        }
      }

      function normalizeEmail(email) {
        return email.trim().toLowerCase();
      }

      function encodePassword(password) {
        try {
          return btoa(password);
        } catch (error) {
          return btoa(unescape(encodeURIComponent(password)));
        }
      }

      function loadUsers() {
        try {
          const stored = localStorage.getItem(USERS_KEY);
          if (!stored) return [];
          const parsed = JSON.parse(stored);
          return Array.isArray(parsed) ? parsed : [];
        } catch (error) {
          console.error("Failed to load users", error);
          return [];
        }
      }

      function saveUsers() {
        localStorage.setItem(USERS_KEY, JSON.stringify(users));
      }

      function findUser(email) {
        return users.find((user) => user.email === email);
      }

      function startSession(user) {
        sessionStorage.setItem(SESSION_KEY, user.email);
      }

      function clearSession() {
        sessionStorage.removeItem(SESSION_KEY);
      }

      function showAuthMessage(message, type = "info") {
        if (!authMessage) return;
        authMessage.textContent = message;
        authMessage.classList.remove("hidden", "info", "error", "success");
        authMessage.classList.add(type);
      }

      function clearAuthMessage() {
        if (!authMessage) return;
        authMessage.textContent = "";
        authMessage.classList.add("hidden");
        authMessage.classList.remove("info", "error", "success");
      }

      function loadTickets() {
        try {
          const stored = localStorage.getItem(STORAGE_KEY);
          if (!stored) return [];
          const parsed = JSON.parse(stored);
          return Array.isArray(parsed) ? parsed : [];
        } catch (error) {
          console.error("Failed to load tickets", error);
          return [];
        }
      }

      function saveTickets() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(tickets));
      }

      function renderTickets() {
        const searchValue = searchTickets.value.trim().toLowerCase();
        const statusValue = statusFilter.value;
        let filtered = tickets.filter((ticket) =>
          ticket.ticketNumber.toLowerCase().includes(searchValue)
        );
        if (statusValue !== "all") {
          filtered = filtered.filter((ticket) => ticket.status === statusValue);
        }

        ticketsContainer.innerHTML = "";

        if (!filtered.length) {
          ticketsContainer.innerHTML =
            '<div class="tickets-empty">No tickets match your filters yet. Create a ticket to get started.</div>';
        } else {
          const ticketGrid = document.createElement("div");
          ticketGrid.className = "ticket-grid";
          filtered
            .slice()
            .sort((a, b) => b.createdAt - a.createdAt)
            .forEach((ticket) => {
              ticketGrid.appendChild(createTicketCard(ticket));
            });
          ticketsContainer.appendChild(ticketGrid);
        }

        const attachmentCount = tickets.reduce((sum, ticket) => sum + ticket.attachments.length, 0);
        const openTickets = tickets.filter((ticket) => ticket.status === "open").length;
        ticketCount.textContent = `${tickets.length} ${tickets.length === 1 ? "ticket" : "tickets"}`;
        statTickets.textContent = tickets.length;
        statAttachments.textContent = attachmentCount;
        statOpen.textContent = openTickets;
      }

      function createTicketCard(ticket) {
        const node = ticketTemplate.content.firstElementChild.cloneNode(true);
        node.dataset.ticketId = ticket.id;
        node.querySelector("[data-ticket-number]").textContent = `Ticket #${ticket.ticketNumber}`;
        node.querySelector("[data-location]").textContent = ticket.location || "No site specified";
        node.querySelector("[data-utility]").textContent = ticket.utilityType
          ? `Locator: ${ticket.utilityType}`
          : "";
        node.querySelector("[data-due]").textContent = ticket.dueDate
          ? `Due: ${new Date(ticket.dueDate).toLocaleDateString()}`
          : "No due date";
        node.querySelector("[data-notes]").textContent = ticket.notes || "No notes recorded.";

        const badge = node.querySelector("[data-status-badge]");
        badge.textContent = ticket.status === "completed" ? "Completed" : "Open";
        badge.style.background =
          ticket.status === "completed" ? "rgba(82, 214, 178, 0.2)" : "rgba(19, 99, 223, 0.1)";
        badge.style.color = ticket.status === "completed" ? "#127c5c" : "var(--primary-dark)";

        const attachmentsWrapper = node.querySelector("[data-attachments]");
        if (!ticket.attachments.length) {
          attachmentsWrapper.textContent = "No photos attached.";
        } else {
          ticket.attachments.forEach((attachment, index) => {
            const img = document.createElement("img");
            img.src = attachment.dataUrl;
            img.alt = `${ticket.ticketNumber} attachment ${index + 1}`;
            img.loading = "lazy";
            img.addEventListener("click", () => openImage(attachment.dataUrl));
            attachmentsWrapper.appendChild(img);
          });
        }

        return node;
      }

      function openImage(src) {
        if (!("showModal" in imageDialog)) {
          window.open(src, "_blank");
          return;
        }
        dialogImage.src = src;
        imageDialog.showModal();
      }

      imageDialog?.addEventListener("click", (event) => {
        if (event.target === imageDialog) {
          imageDialog.close();
        }
      });

      exportBtn.addEventListener("click", () => {
        const dataStr = JSON.stringify(tickets, null, 2);
        const blob = new Blob([dataStr], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const anchor = document.createElement("a");
        anchor.href = url;
        anchor.download = "utility-locate-tickets.json";
        anchor.click();
        URL.revokeObjectURL(url);
      });

      searchTickets.addEventListener("input", renderTickets);
      statusFilter.addEventListener("change", renderTickets);

      resetFormBtn.addEventListener("click", () => {
        photoPreview.innerHTML = "";
      });

      photoInput.addEventListener("change", () => {
        photoPreview.innerHTML = "";
        const files = Array.from(photoInput.files || []);
        if (!files.length) {
          photoPreview.innerHTML = "";
          return;
        }
        files.forEach((file) => {
          const reader = new FileReader();
          reader.onload = (event) => {
            const photoCard = document.createElement("div");
            photoCard.className = "photo-card";
            const img = document.createElement("img");
            img.src = event.target?.result;
            img.alt = file.name;
            const caption = document.createElement("span");
            caption.textContent = file.name;
            photoCard.append(img, caption);
            photoPreview.appendChild(photoCard);
          };
          reader.readAsDataURL(file);
        });
      });

      ticketForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        const formData = new FormData(ticketForm);
        const ticketNumber = (formData.get("ticketNumber") || "").toString().trim();
        if (!ticketNumber) {
          alert("Ticket number is required");
          return;
        }

        const newTicket = {
          id: crypto.randomUUID ? crypto.randomUUID() : `ticket-${Date.now()}`,
          ticketNumber,
          location: (formData.get("location") || "").toString().trim(),
          utilityType: (formData.get("utilityType") || "").toString(),
          dueDate: formData.get("dueDate") || "",
          notes: (formData.get("notes") || "").toString().trim(),
          status: "open",
          createdAt: Date.now(),
          attachments: await Promise.all(getPhotoAttachments())
        };

        tickets.push(newTicket);
        saveTickets();
        ticketForm.reset();
        photoPreview.innerHTML = "";
        renderTickets();
      });

      function getPhotoAttachments() {
        const files = Array.from(photoInput.files || []);
        return files.map((file) =>
          new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = (event) => {
              resolve({
                name: file.name,
                dataUrl: event.target?.result,
                uploadedAt: Date.now()
              });
            };
            reader.readAsDataURL(file);
          })
        );
      }
    </script>
  </body>
</html>
