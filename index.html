<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta
      name="description"
      content="Securely log in to the CFM Utility Locate Tracker to capture locate tickets, upload photos, and review archive records."
    />
    <title>CFM Utility Locate Tracker</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Space+Grotesk:wght@500;600&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        color-scheme: light;
        --bg: #f3f4f8;
        --surface: #ffffff;
        --surface-subtle: rgba(255, 255, 255, 0.65);
        --primary: #1363df;
        --primary-dark: #0f4cc3;
        --accent: #52d6b2;
        --text: #121625;
        --muted: #5e6478;
        --border: rgba(19, 99, 223, 0.12);
        --radius-lg: 24px;
        --radius: 16px;
        --shadow: 0 24px 48px rgba(14, 38, 74, 0.12);
      }

      *,
      *::before,
      *::after {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: radial-gradient(circle at top, rgba(19, 99, 223, 0.18), transparent 60%), var(--bg);
        color: var(--text);
        min-height: 100vh;
      }

      .hidden {
        display: none !important;
      }

      .auth-screen {
        min-height: 100vh;
        display: grid;
        place-items: center;
        padding: clamp(2rem, 6vw, 4rem);
      }

      .auth-card {
        width: min(100%, 460px);
        background: var(--surface);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow);
        padding: clamp(2.2rem, 6vw, 3.2rem);
        display: grid;
        gap: 1.5rem;
        text-align: center;
      }

      .auth-brand {
        display: grid;
        gap: 0.9rem;
        justify-items: center;
      }

      .auth-brand span {
        width: 56px;
        height: 56px;
        border-radius: 18px;
        display: grid;
        place-items: center;
        font-family: "Space Grotesk", sans-serif;
        font-size: 1.35rem;
        color: #fff;
        background: linear-gradient(135deg, var(--primary), #48a9f8);
        box-shadow: 0 18px 36px rgba(19, 99, 223, 0.28);
      }

      .auth-subtitle {
        font-size: 0.98rem;
        color: var(--muted);
      }

      .auth-form {
        display: grid;
        gap: 1rem;
        text-align: left;
      }

      .auth-form button {
        justify-content: center;
        width: 100%;
      }

      .auth-message {
        padding: 0.85rem 1rem;
        border-radius: 12px;
        font-size: 0.92rem;
        text-align: left;
      }

      .auth-message.info {
        background: rgba(19, 99, 223, 0.08);
        color: var(--primary-dark);
      }

      .auth-message.success {
        background: rgba(82, 214, 178, 0.18);
        color: #106e52;
      }

      .auth-message.error {
        background: rgba(232, 94, 94, 0.15);
        color: #9c1d1d;
      }

      .auth-toggle {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 0.4rem;
        padding: 0.35rem;
        border-radius: 14px;
        background: rgba(19, 99, 223, 0.08);
      }

      .auth-toggle-btn {
        border: none;
        background: none;
        border-radius: 10px;
        padding: 0.75rem 1rem;
        font-weight: 600;
        font-size: 0.95rem;
        color: var(--muted);
        cursor: pointer;
        transition: background 0.25s ease, color 0.25s ease, box-shadow 0.25s ease;
      }

      .auth-toggle-btn.active {
        background: var(--surface);
        color: var(--primary-dark);
        box-shadow: 0 12px 24px rgba(19, 99, 223, 0.16);
      }

      .auth-toggle-btn:focus-visible {
        outline: 2px solid rgba(19, 99, 223, 0.4);
        outline-offset: 2px;
      }

      .auth-toggle-btn[disabled] {
        cursor: not-allowed;
        opacity: 0.55;
      }

      h1,
      h2,
      h3 {
        font-family: "Space Grotesk", "Inter", sans-serif;
        font-weight: 600;
        margin: 0;
        color: var(--text);
      }

      p {
        margin: 0;
        color: var(--muted);
      }

      header {
        position: sticky;
        top: 0;
        z-index: 20;
        backdrop-filter: blur(16px);
        background: rgba(243, 244, 248, 0.88);
        border-bottom: 1px solid var(--border);
      }

      .nav-container {
        max-width: 1120px;
        margin: 0 auto;
        padding: 1.1rem clamp(1rem, 4vw, 2.5rem);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 1.25rem;
        flex-wrap: wrap;
        text-align: center;
        position: relative;
      }

      .nav-left {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 1.35rem;
        flex-wrap: wrap;
      }

      .brand {
        display: inline-flex;
        align-items: center;
        gap: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--primary-dark);
        font-weight: 600;
        font-size: 0.95rem;
      }

      .nav-right {
        position: absolute;
        right: clamp(1rem, 4vw, 2.5rem);
        display: inline-flex;
        align-items: center;
        gap: 0.75rem;
      }

      .user-tag {
        background: rgba(18, 22, 37, 0.08);
        color: var(--text);
        border-radius: 999px;
        padding: 0.45rem 0.9rem;
        font-size: 0.85rem;
        font-weight: 600;
      }

      .logout-btn {
        padding: 0.55rem 1.15rem;
      }

      .brand span {
        width: 44px;
        height: 44px;
        border-radius: 14px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-family: "Space Grotesk", sans-serif;
        font-size: 1.25rem;
        color: #fff;
        background: linear-gradient(135deg, var(--primary), #48a9f8);
        box-shadow: 0 14px 28px rgba(19, 99, 223, 0.32);
      }

      main {
        max-width: 1120px;
        margin: 0 auto;
        padding: clamp(2.5rem, 6vw, 4.5rem) clamp(1.25rem, 5vw, 2.75rem) 4rem;
        display: grid;
        gap: clamp(2rem, 5vw, 3.5rem);
      }

      .hero {
        background: none;
        box-shadow: none;
        border-radius: 0;
        padding: clamp(1.5rem, 4vw, 3rem) 0 clamp(2rem, 5vw, 3.5rem);
        position: relative;
        overflow: visible;
        isolation: isolate;
      }

      .hero::after {
        content: none;
      }

      .hero-content {
        display: grid;
        gap: clamp(1rem, 3vw, 1.5rem);
        position: relative;
        z-index: 1;
        justify-items: center;
        text-align: center;
        width: 100%;
      }

      .hero-logo {
        width: clamp(260px, 85vw, 720px);
        margin: 0 auto;
        padding: 0;
        display: grid;
        gap: clamp(1rem, 3vw, 1.5rem);
        place-items: center;
        text-align: center;
      }

      .hero-wordmark {
        font-family: "Space Grotesk", "Inter", sans-serif;
        font-weight: 600;
        font-size: clamp(2.5rem, 8vw, 4.25rem);
        color: var(--primary-dark);
        letter-spacing: 0.06em;
        text-transform: uppercase;
      }

      .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        border: 0;
      }

      .stats {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        margin-top: 1rem;
        justify-content: center;
      }

      .stat-card {
        padding: 1.15rem 1.4rem;
        border-radius: 18px;
        background: rgba(19, 99, 223, 0.08);
        color: var(--primary-dark);
        min-width: 160px;
      }

      .stat-card strong {
        display: block;
        font-size: 1.5rem;
        margin-bottom: 0.35rem;
      }

      section {
        background: var(--surface);
        border-radius: var(--radius-lg);
        padding: clamp(1.75rem, 5vw, 2.75rem);
        box-shadow: var(--shadow);
      }

      .section-heading {
        display: flex;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 1rem;
        align-items: center;
        margin-bottom: clamp(1.5rem, 4vw, 2rem);
      }

      .section-heading p {
        max-width: 520px;
      }

      .ticket-form {
        display: grid;
        gap: 1rem;
      }

      .form-grid {
        display: grid;
        gap: 1rem;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      }

      label {
        display: grid;
        gap: 0.45rem;
        font-weight: 600;
        color: var(--text);
        font-size: 0.95rem;
      }

      input,
      textarea,
      select {
        font: inherit;
        padding: 0.75rem 0.85rem;
        border-radius: 12px;
        border: 1px solid rgba(18, 22, 37, 0.12);
        background: rgba(255, 255, 255, 0.96);
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
      }

      input:focus,
      textarea:focus,
      select:focus {
        outline: none;
        border-color: rgba(19, 99, 223, 0.5);
        box-shadow: 0 0 0 3px rgba(19, 99, 223, 0.12);
      }

      textarea {
        resize: vertical;
        min-height: 120px;
      }

      .file-input {
        border: 1px dashed rgba(19, 99, 223, 0.45);
        background: rgba(19, 99, 223, 0.06);
        border-radius: 16px;
        padding: 1.5rem;
        text-align: center;
        color: var(--muted);
        display: grid;
        gap: 0.9rem;
        justify-items: center;
        transition: background 0.2s ease, border 0.2s ease;
      }

      .file-input strong {
        font-size: 1rem;
        color: var(--text);
      }

      .file-input:hover,
      .file-input:focus-within {
        background: rgba(19, 99, 223, 0.1);
        border-color: rgba(19, 99, 223, 0.9);
      }

      .file-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 0.65rem;
        justify-content: center;
      }

      .file-trigger {
        background: rgba(19, 99, 223, 0.16);
        color: var(--primary-dark);
        box-shadow: none;
      }

      .file-trigger:hover {
        background: rgba(19, 99, 223, 0.24);
      }

      .file-trigger:focus-visible {
        outline: 2px solid rgba(19, 99, 223, 0.4);
        outline-offset: 2px;
      }

      .visually-hidden {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0 0 0 0);
        white-space: nowrap;
        border: 0;
      }

      .form-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
        justify-content: flex-end;
      }

      button {
        font: inherit;
        border-radius: 12px;
        border: none;
        padding: 0.75rem 1.4rem;
        font-weight: 600;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
      }

      .btn-primary {
        background: linear-gradient(135deg, var(--primary), var(--primary-dark));
        color: #fff;
        box-shadow: 0 16px 32px rgba(19, 99, 223, 0.28);
      }

      .btn-primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 18px 36px rgba(19, 99, 223, 0.35);
      }

      .btn-secondary {
        background: rgba(18, 22, 37, 0.08);
        color: var(--text);
      }

      .btn-secondary:hover {
        background: rgba(18, 22, 37, 0.12);
      }

      .photo-preview {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 0.8rem;
      }

      .photo-card {
        border-radius: 14px;
        overflow: hidden;
        background: rgba(19, 99, 223, 0.08);
        border: 1px solid rgba(19, 99, 223, 0.18);
        display: grid;
        gap: 0.4rem;
      }

      .photo-card img {
        width: 100%;
        height: 120px;
        object-fit: cover;
      }

      .photo-card span {
        display: block;
        padding: 0.55rem 0.75rem 0.7rem;
        font-size: 0.85rem;
        color: var(--muted);
        background: rgba(255, 255, 255, 0.85);
      }

      .tickets-toolbar {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        align-items: center;
        justify-content: flex-start;
        margin-bottom: 1.5rem;
      }

      .tickets-toolbar input {
        flex: 1 1 260px;
        min-width: 200px;
      }

      .tickets-toolbar select {
        flex: 0 0 auto;
      }

      .tickets-empty {
        text-align: center;
        padding: 3rem 1rem;
        color: var(--muted);
      }

      .ticket-grid {
        display: grid;
        gap: 1.25rem;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      }

      .ticket-card {
        background: rgba(255, 255, 255, 0.92);
        border-radius: 18px;
        padding: 1.4rem;
        border: 1px solid rgba(18, 22, 37, 0.06);
        display: grid;
        gap: 1.1rem;
        position: relative;
      }

      .ticket-card header {
        background: none;
        border: 0;
        position: static;
        padding: 0;
      }

      .ticket-card h3 {
        font-size: 1.25rem;
      }

      .ticket-meta {
        display: grid;
        gap: 0.55rem;
        font-size: 0.92rem;
      }

      .ticket-meta span {
        color: var(--muted);
      }

      .attachment-thumbs {
        display: flex;
        gap: 0.5rem;
      }

      .attachment-thumbs img {
        width: 52px;
        height: 52px;
        border-radius: 12px;
        object-fit: cover;
        border: 1px solid rgba(19, 99, 223, 0.25);
      }

      .badge {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        background: rgba(19, 99, 223, 0.1);
        color: var(--primary-dark);
        border-radius: 999px;
        padding: 0.35rem 0.75rem;
        font-size: 0.8rem;
        font-weight: 600;
      }

      details {
        background: rgba(19, 99, 223, 0.05);
        border-radius: 14px;
        padding: 0.9rem 1rem;
      }

      details summary {
        cursor: pointer;
        font-weight: 600;
        color: var(--primary-dark);
        list-style: none;
      }

      details[open] summary::after {
        content: "";
      }

      summary::-webkit-details-marker {
        display: none;
      }

      .details-body {
        margin-top: 0.85rem;
        display: grid;
        gap: 0.75rem;
      }

      dialog {
        border: none;
        border-radius: 18px;
        padding: 0;
        box-shadow: 0 20px 50px rgba(12, 27, 51, 0.45);
        background: rgba(10, 15, 28, 0.85);
      }

      dialog::backdrop {
        background: rgba(5, 8, 15, 0.55);
      }

      @media (max-width: 720px) {
        header {
          position: static;
        }

        .nav-container {
          justify-content: center;
          gap: 0.9rem;
        }

        .nav-left {
          width: 100%;
          justify-content: center;
          gap: 0.9rem;
        }

        .brand {
          justify-content: center;
        }

        .nav-right {
          position: static;
          width: 100%;
          justify-content: center;
        }

        .badge {
          width: 100%;
          justify-content: center;
        }

        .hero {
          padding: 1.75rem;
        }

      }
    </style>
  </head>
  <body>
    <div class="auth-screen" id="authScreen">
      <div class="auth-card" role="region" aria-labelledby="authTitle">
        <div class="auth-brand">
          <span>CF</span>
          <h1 id="authTitle">CFM Utility Locate Tracker</h1>
        </div>
        <p class="auth-subtitle">
          Log in to manage locate tickets, attachments, and onsite documentation in one streamlined workspace.
        </p>
        <div id="authMessage" class="auth-message hidden" role="status" aria-live="polite"></div>
        <div class="auth-toggle" id="authToggle" role="tablist" aria-label="Authentication options">
          <button
            type="button"
            class="auth-toggle-btn active"
            id="toggleLogin"
            role="tab"
            aria-selected="true"
          >
            Existing user
          </button>
          <button
            type="button"
            class="auth-toggle-btn"
            id="toggleRegister"
            role="tab"
            aria-selected="false"
          >
            Create account
          </button>
        </div>

        <form class="auth-form" id="loginForm" autocomplete="on" role="tabpanel" aria-labelledby="toggleLogin">
          <label>
            Email address
            <input type="email" id="loginEmail" name="loginEmail" autocomplete="email" required />
          </label>
          <label>
            Access password
            <input
              type="password"
              id="loginPassword"
              name="loginPassword"
              autocomplete="current-password"
              required
            />
          </label>
          <button type="submit" class="btn-primary">Sign in</button>
        </form>

        <form
          class="auth-form hidden"
          id="registerForm"
          autocomplete="off"
          role="tabpanel"
          aria-labelledby="toggleRegister"
          aria-hidden="true"
        >
          <label>
            Full name
            <input type="text" id="registerName" name="registerName" autocomplete="name" required />
          </label>
          <label>
            Email address
            <input type="email" id="registerEmail" name="registerEmail" autocomplete="email" required />
          </label>
          <label>
            Create password
            <input
              type="password"
              id="registerPassword"
              name="registerPassword"
              autocomplete="new-password"
              minlength="6"
              required
            />
          </label>
          <label>
            Confirm password
            <input
              type="password"
              id="registerConfirm"
              name="registerConfirm"
              autocomplete="new-password"
              minlength="6"
              required
            />
          </label>
          <button type="submit" class="btn-primary">Create account</button>
        </form>
      </div>
    </div>

    <div id="appShell" class="hidden">
      <header>
        <div class="nav-container">
          <div class="nav-left">
            <a class="brand" href="#top"><span>CF</span>CFM Utility Locate Tracker</a>
          </div>
          <div class="nav-right">
            <div class="user-tag hidden" id="userGreeting"></div>
            <button type="button" class="btn-secondary logout-btn hidden" id="logoutBtn">Log out</button>
          </div>
        </div>
      </header>

      <main>
      <section class="hero" id="top">
        <div class="hero-content">
          <figure class="hero-logo" role="img" aria-label="City of Fort Myers wordmark">
            <div class="hero-wordmark">City of Fort Myers</div>
          </figure>
          <div class="stats" role="list">
            <div class="stat-card" role="listitem">
              <strong id="statTickets">0</strong>
              Tickets logged
            </div>
            <div class="stat-card" role="listitem">
              <strong id="statAttachments">0</strong>
              Photos archived
            </div>
          </div>
        </div>
      </section>

      <section aria-labelledby="formHeading">
        <div class="section-heading">
          <div>
            <h2 id="formHeading">Create a completed ticket</h2>
            <p>
              Enter the ticket details, upload field photos, and include any additional information related to the locate.
            </p>
          </div>
        </div>

        <form class="ticket-form" id="ticketForm">
          <div class="form-grid">
            <label>
              Ticket number
              <input type="text" name="ticketNumber" id="ticketNumber" required placeholder="e.g. 23-584217" />
            </label>
            <label>
              Job site / address
              <input type="text" name="location" id="location" placeholder="123 Main St, Springfield" />
            </label>
            <label>
              Locator
              <select name="utilityType" id="utilityType">
                <option value="">Select locator</option>
                <option>T. Benza</option>
                <option>L. Schrimer</option>
                <option>J. Juhasz</option>
                <option>S. Lee</option>
                <option>M. Lam</option>
                <option>S. McDonald</option>
              </select>
            </label>
            <label>
              Date located
              <input type="date" name="dueDate" id="dueDate" />
            </label>
          </div>

          <label>
            Notes
            <textarea name="notes" id="notes" placeholder="Flags, obstacles, access notes, and contacts..."></textarea>
          </label>

          <div class="file-input" role="group" aria-labelledby="photoFieldHeading">
            <strong id="photoFieldHeading">Attach field photos</strong>
            <span>Upload images from your device or capture new photos on your phone.</span>
            <div class="file-actions">
              <button type="button" class="file-trigger" id="openPhotoPicker">Choose photos</button>
              <button type="button" class="file-trigger" id="openCameraCapture">Use camera</button>
            </div>
            <input
              type="file"
              id="photos"
              name="photos"
              accept="image/*"
              multiple
              class="visually-hidden"
            />
            <input
              type="file"
              id="photoCapture"
              accept="image/*"
              capture="environment"
              class="visually-hidden"
            />
          </div>

          <div class="photo-preview" id="photoPreview" aria-live="polite"></div>

          <div class="form-actions">
            <button type="reset" class="btn-secondary" id="resetForm">Clear form</button>
            <button type="submit" class="btn-primary">Save ticket</button>
          </div>
        </form>
      </section>

      <section aria-labelledby="ticketsHeading">
        <div class="section-heading">
          <div>
            <h2 id="ticketsHeading">Ticket archive</h2>
            <p>Search by ticket number, filter by locator, and review attachments for each locate request.</p>
          </div>
        </div>

        <div class="tickets-toolbar">
          <input type="search" id="searchTickets" placeholder="Search ticket number..." />
          <select id="locatorFilter">
            <option value="all">All locators</option>
            <option value="T. Benza">T. Benza</option>
            <option value="L. Schrimer">L. Schrimer</option>
            <option value="J. Juhasz">J. Juhasz</option>
            <option value="S. Lee">S. Lee</option>
            <option value="M. Lam">M. Lam</option>
            <option value="S. McDonald">S. McDonald</option>
          </select>
        </div>

        <div id="ticketsContainer"></div>
      </section>
      </main>

      <template id="ticketTemplate">
        <article class="ticket-card">
          <header>
            <h3 data-ticket-number></h3>
            <div class="ticket-meta">
              <span data-location></span>
              <span data-utility></span>
              <span data-due></span>
            </div>
          </header>
          <details>
            <summary>Notes & photos</summary>
            <div class="details-body">
              <p data-notes></p>
              <div class="attachment-thumbs" data-attachments></div>
            </div>
          </details>
        </article>
      </template>

      <dialog id="imageDialog">
        <img src="" alt="Ticket attachment" id="dialogImage" style="max-width: 90vw; max-height: 80vh" />
      </dialog>
    </div>

    <script>
      const STORAGE_KEY = "utilityLocateTickets_v1";
      const USERS_KEY = "cfmLocateUsers_v1";
      const SESSION_KEY = "cfmLocateSession_v1";

      const appShell = document.getElementById("appShell");
      const authScreen = document.getElementById("authScreen");
      const authMessage = document.getElementById("authMessage");
      const authLoginForm = document.getElementById("loginForm");
      const authRegisterForm = document.getElementById("registerForm");
      const toggleLoginBtn = document.getElementById("toggleLogin");
      const toggleRegisterBtn = document.getElementById("toggleRegister");
      const loginEmailInput = document.getElementById("loginEmail");
      const loginPasswordInput = document.getElementById("loginPassword");
      const registerNameInput = document.getElementById("registerName");
      const registerEmailInput = document.getElementById("registerEmail");
      const registerPasswordInput = document.getElementById("registerPassword");
      const registerConfirmInput = document.getElementById("registerConfirm");
      const userGreeting = document.getElementById("userGreeting");
      const logoutBtn = document.getElementById("logoutBtn");

      const ticketForm = document.getElementById("ticketForm");
      const photoInput = document.getElementById("photos");
      const photoPreview = document.getElementById("photoPreview");
      const cameraInput = document.getElementById("photoCapture");
      const openPhotoPickerBtn = document.getElementById("openPhotoPicker");
      const openCameraCaptureBtn = document.getElementById("openCameraCapture");
      const ticketsContainer = document.getElementById("ticketsContainer");
      const ticketTemplate = document.getElementById("ticketTemplate");
      const searchTickets = document.getElementById("searchTickets");
      const locatorFilter = document.getElementById("locatorFilter");

      // Ensure any legacy export controls are removed from the archive toolbar
      document
        .querySelectorAll(".tickets-toolbar button")
        .forEach((button) => button.remove());
      const statTickets = document.getElementById("statTickets");
      const statAttachments = document.getElementById("statAttachments");
      const resetFormBtn = document.getElementById("resetForm");
      const imageDialog = document.getElementById("imageDialog");
      const dialogImage = document.getElementById("dialogImage");

      const supportsFileAggregation = (() => {
        if (typeof DataTransfer === "undefined") {
          return false;
        }
        try {
          new DataTransfer();
          return true;
        } catch (error) {
          return false;
        }
      })();
      let fallbackPhotoFiles = [];
      let queuedExistingPhotoFiles = [];

      let users = loadUsers();
      let tickets = loadTickets();

      initializeAuth();
      renderTickets();

      function getAllPhotoFiles() {
        if (!photoInput) {
          return [];
        }
        if (supportsFileAggregation) {
          return Array.from(photoInput.files || []);
        }
        return fallbackPhotoFiles.slice();
      }

      function setAllPhotoFiles(files) {
        if (!photoInput) {
          return;
        }
        if (supportsFileAggregation) {
          const transfer = new DataTransfer();
          files.forEach((file) => transfer.items.add(file));
          photoInput.files = transfer.files;
        } else {
          fallbackPhotoFiles = files.slice();
        }
        if (!files.length) {
          photoInput.value = "";
        }
      }

      function appendFilesToPhotoInput(newFiles) {
        if (!newFiles.length) {
          return;
        }
        const combined = getAllPhotoFiles().concat(newFiles);
        setAllPhotoFiles(combined);
        updatePhotoPreview();
      }

      function updatePhotoPreview() {
        if (!photoPreview) {
          return;
        }
        photoPreview.innerHTML = "";
        const files = getAllPhotoFiles();
        if (!files.length) {
          return;
        }
        files.forEach((file) => {
          const reader = new FileReader();
          reader.onload = (event) => {
            const photoCard = document.createElement("div");
            photoCard.className = "photo-card";
            const img = document.createElement("img");
            img.src = event.target?.result;
            img.alt = file.name;
            const caption = document.createElement("span");
            caption.textContent = file.name;
            photoCard.append(img, caption);
            photoPreview.appendChild(photoCard);
          };
          reader.readAsDataURL(file);
        });
      }

      function clearPhotoInputs() {
        queuedExistingPhotoFiles = [];
        setAllPhotoFiles([]);
        if (cameraInput) {
          cameraInput.value = "";
        }
        updatePhotoPreview();
      }

      authLoginForm?.addEventListener("submit", (event) => {
        event.preventDefault();
        const email = normalizeEmail(loginEmailInput?.value || "");
        const password = loginPasswordInput?.value || "";
        if (!email || !password) {
          showAuthMessage("Both email and password are required.", "error");
          return;
        }

        const user = findUser(email);
        if (!user || user.password !== encodePassword(password)) {
          showAuthMessage("We couldn't match those credentials. Try again.", "error");
          return;
        }

        startSession(user);
        authLoginForm.reset();
        clearAuthMessage();
        showApp(user);
      });

      authRegisterForm?.addEventListener("submit", (event) => {
        event.preventDefault();
        const name = (registerNameInput?.value || "").trim();
        const email = normalizeEmail(registerEmailInput?.value || "");
        const password = registerPasswordInput?.value || "";
        const confirm = registerConfirmInput?.value || "";

        if (!name || !email || !password || !confirm) {
          showAuthMessage("All fields are required to create an account.", "error");
          return;
        }

        if (password.length < 6) {
          showAuthMessage("Passwords must be at least 6 characters long.", "error");
          return;
        }

        if (password !== confirm) {
          showAuthMessage("Passwords do not match. Please re-enter them.", "error");
          return;
        }

        if (findUser(email)) {
          showAuthMessage("That email already has access. Sign in instead.", "error");
          setAuthMode("login");
          if (loginEmailInput) {
            loginEmailInput.value = email;
          }
          loginPasswordInput?.focus();
          return;
        }

        const newUser = { name, email, password: encodePassword(password) };
        users.push(newUser);
        saveUsers();
        updateAuthToggleAvailability();
        startSession(newUser);
        authRegisterForm.reset();
        clearAuthMessage();
        showApp(newUser);
      });

      toggleRegisterBtn?.addEventListener("click", () => {
        clearAuthMessage();
        setAuthMode("register");
      });

      toggleLoginBtn?.addEventListener("click", () => {
        if (!users.length) {
          showAuthMessage("Create an account to get started.", "info");
          return;
        }
        clearAuthMessage();
        setAuthMode("login");
      });

      logoutBtn?.addEventListener("click", () => {
        clearSession();
        authLoginForm?.reset();
        authRegisterForm?.reset();
        showAuth("login", { clearMessage: false });
        showAuthMessage("You have been signed out.", "info");
      });

      function initializeAuth() {
        const sessionEmail = sessionStorage.getItem(SESSION_KEY);
        if (sessionEmail) {
          const existingUser = findUser(sessionEmail);
          if (existingUser) {
            showApp(existingUser);
            return;
          }
          clearSession();
        }
        showAuth(users.length ? "login" : "register");
      }

      function showApp(user) {
        updateUserUI(user);
        authScreen?.classList.add("hidden");
        appShell?.classList.remove("hidden");
      }

      function showAuth(mode = users.length ? "login" : "register", { clearMessage = true } = {}) {
        if (clearMessage) {
          clearAuthMessage();
        }
        updateUserUI();
        appShell?.classList.add("hidden");
        authScreen?.classList.remove("hidden");
        updateAuthToggleAvailability();
        setAuthMode(mode);
      }

      function updateAuthToggleAvailability() {
        const hasUsers = users.length > 0;
        if (toggleLoginBtn) {
          toggleLoginBtn.disabled = !hasUsers;
          toggleLoginBtn.setAttribute("aria-disabled", String(!hasUsers));
          toggleLoginBtn.title = hasUsers
            ? "Sign in to an existing account"
            : "Create an account to get started";
        }
        if (toggleRegisterBtn) {
          toggleRegisterBtn.title = "Create a new team account";
        }
      }

      function setAuthMode(mode) {
        const nextMode = mode === "login" && !users.length ? "register" : mode;
        const isLogin = nextMode === "login";
        authLoginForm?.classList.toggle("hidden", !isLogin);
        authRegisterForm?.classList.toggle("hidden", isLogin);
        authLoginForm?.setAttribute("aria-hidden", isLogin ? "false" : "true");
        authRegisterForm?.setAttribute("aria-hidden", isLogin ? "true" : "false");
        toggleLoginBtn?.classList.toggle("active", isLogin);
        toggleRegisterBtn?.classList.toggle("active", !isLogin);
        toggleLoginBtn?.setAttribute("aria-selected", String(isLogin));
        toggleRegisterBtn?.setAttribute("aria-selected", String(!isLogin));
        toggleLoginBtn?.setAttribute("tabindex", isLogin ? "0" : "-1");
        toggleRegisterBtn?.setAttribute("tabindex", !isLogin ? "0" : "-1");
        window.requestAnimationFrame(() => {
          if (isLogin) {
            loginEmailInput?.focus();
          } else {
            registerNameInput?.focus();
          }
        });
      }

      function updateUserUI(user = null) {
        if (!userGreeting || !logoutBtn) return;
        if (user) {
          userGreeting.textContent = user.name
            ? `Signed in as ${user.name}`
            : `Signed in as ${user.email}`;
          userGreeting.classList.remove("hidden");
          logoutBtn.classList.remove("hidden");
        } else {
          userGreeting.textContent = "";
          userGreeting.classList.add("hidden");
          logoutBtn.classList.add("hidden");
        }
      }

      function normalizeEmail(email) {
        return email.trim().toLowerCase();
      }

      function encodePassword(password) {
        try {
          return btoa(password);
        } catch (error) {
          return btoa(unescape(encodeURIComponent(password)));
        }
      }

      function loadUsers() {
        try {
          const stored = localStorage.getItem(USERS_KEY);
          if (!stored) return [];
          const parsed = JSON.parse(stored);
          return Array.isArray(parsed) ? parsed : [];
        } catch (error) {
          console.error("Failed to load users", error);
          return [];
        }
      }

      function saveUsers() {
        localStorage.setItem(USERS_KEY, JSON.stringify(users));
      }

      function findUser(email) {
        return users.find((user) => user.email === email);
      }

      function startSession(user) {
        sessionStorage.setItem(SESSION_KEY, user.email);
      }

      function clearSession() {
        sessionStorage.removeItem(SESSION_KEY);
      }

      function showAuthMessage(message, type = "info") {
        if (!authMessage) return;
        authMessage.textContent = message;
        authMessage.classList.remove("hidden", "info", "error", "success");
        authMessage.classList.add(type);
      }

      function clearAuthMessage() {
        if (!authMessage) return;
        authMessage.textContent = "";
        authMessage.classList.add("hidden");
        authMessage.classList.remove("info", "error", "success");
      }

      function loadTickets() {
        try {
          const stored = localStorage.getItem(STORAGE_KEY);
          if (!stored) return [];
          const parsed = JSON.parse(stored);
          return Array.isArray(parsed) ? parsed : [];
        } catch (error) {
          console.error("Failed to load tickets", error);
          return [];
        }
      }

      function saveTickets() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(tickets));
      }

      function renderTickets() {
        const searchValue = searchTickets.value.trim().toLowerCase();
        const locatorValue = locatorFilter ? locatorFilter.value : "all";
        let filtered = tickets.filter((ticket) =>
          ticket.ticketNumber.toLowerCase().includes(searchValue)
        );
        if (locatorValue !== "all") {
          filtered = filtered.filter((ticket) => ticket.utilityType === locatorValue);
        }

        ticketsContainer.innerHTML = "";

        if (!filtered.length) {
          ticketsContainer.innerHTML =
            '<div class="tickets-empty">No tickets match your filters yet. Create a ticket to get started.</div>';
        } else {
          const ticketGrid = document.createElement("div");
          ticketGrid.className = "ticket-grid";
          filtered
            .slice()
            .sort((a, b) => b.createdAt - a.createdAt)
            .forEach((ticket) => {
              ticketGrid.appendChild(createTicketCard(ticket));
            });
          ticketsContainer.appendChild(ticketGrid);
        }

        const attachmentCount = tickets.reduce((sum, ticket) => sum + ticket.attachments.length, 0);
        statTickets.textContent = tickets.length;
        statAttachments.textContent = attachmentCount;
      }

      function createTicketCard(ticket) {
        const node = ticketTemplate.content.firstElementChild.cloneNode(true);
        node.dataset.ticketId = ticket.id;
        node.querySelector("[data-ticket-number]").textContent = `Ticket #${ticket.ticketNumber}`;
        node.querySelector("[data-location]").textContent = ticket.location || "No site specified";
        node.querySelector("[data-utility]").textContent = ticket.utilityType
          ? `Locator: ${ticket.utilityType}`
          : "";
        node.querySelector("[data-due]").textContent = ticket.dueDate
          ? `Date: ${new Date(ticket.dueDate).toLocaleDateString()}`
          : "No date recorded";
        node.querySelector("[data-notes]").textContent = ticket.notes || "No notes recorded.";

        const attachmentsWrapper = node.querySelector("[data-attachments]");
        if (!ticket.attachments.length) {
          attachmentsWrapper.textContent = "No photos attached.";
        } else {
          ticket.attachments.forEach((attachment, index) => {
            const img = document.createElement("img");
            img.src = attachment.dataUrl;
            img.alt = `${ticket.ticketNumber} attachment ${index + 1}`;
            img.loading = "lazy";
            img.addEventListener("click", () => openImage(attachment.dataUrl));
            attachmentsWrapper.appendChild(img);
          });
        }

        return node;
      }

      function openImage(src) {
        if (!("showModal" in imageDialog)) {
          window.open(src, "_blank");
          return;
        }
        dialogImage.src = src;
        imageDialog.showModal();
      }

      imageDialog?.addEventListener("click", (event) => {
        if (event.target === imageDialog) {
          imageDialog.close();
        }
      });

      searchTickets.addEventListener("input", renderTickets);
      locatorFilter?.addEventListener("change", renderTickets);

      openPhotoPickerBtn?.addEventListener("click", () => {
        queuedExistingPhotoFiles = getAllPhotoFiles();
        photoInput?.click();
      });

      openCameraCaptureBtn?.addEventListener("click", () => {
        cameraInput?.click();
      });

      cameraInput?.addEventListener("change", () => {
        const files = Array.from(cameraInput.files || []);
        if (!files.length) {
          return;
        }
        appendFilesToPhotoInput(files);
        cameraInput.value = "";
      });

      photoInput?.addEventListener("change", () => {
        const newSelection = Array.from(photoInput.files || []);
        if (!newSelection.length && queuedExistingPhotoFiles.length) {
          setAllPhotoFiles(queuedExistingPhotoFiles);
          queuedExistingPhotoFiles = [];
          updatePhotoPreview();
          return;
        }
        const combined = queuedExistingPhotoFiles.length
          ? queuedExistingPhotoFiles.concat(newSelection)
          : newSelection;
        setAllPhotoFiles(combined);
        queuedExistingPhotoFiles = [];
        updatePhotoPreview();
      });

      ticketForm.addEventListener("reset", () => {
        clearPhotoInputs();
      });

      resetFormBtn?.addEventListener("click", () => {
        setTimeout(clearPhotoInputs, 0);
      });

      ticketForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        const formData = new FormData(ticketForm);
        const ticketNumber = (formData.get("ticketNumber") || "").toString().trim();
        if (!ticketNumber) {
          alert("Ticket number is required");
          return;
        }

        const newTicket = {
          id: crypto.randomUUID ? crypto.randomUUID() : `ticket-${Date.now()}`,
          ticketNumber,
          location: (formData.get("location") || "").toString().trim(),
          utilityType: (formData.get("utilityType") || "").toString(),
          dueDate: formData.get("dueDate") || "",
          notes: (formData.get("notes") || "").toString().trim(),
          status: "open",
          createdAt: Date.now(),
          attachments: await Promise.all(getPhotoAttachments())
        };

        tickets.push(newTicket);
        saveTickets();
        ticketForm.reset();
        renderTickets();
      });

      function getPhotoAttachments() {
        const files = getAllPhotoFiles();
        return files.map((file) =>
          new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = (event) => {
              resolve({
                name: file.name,
                dataUrl: event.target?.result,
                uploadedAt: Date.now()
              });
            };
            reader.readAsDataURL(file);
          })
        );
      }
    </script>
  </body>
</html>
